var e=require("hexo-fs"),t=require("hexo-log"),i=require("path"),n=require("idouban"),o=require("module");function a(e){return e&&e.__esModule?e.default:e}var s=i.resolve(__dirname,"../lib");const r=`<div id="idouban"></div>
<link rel="stylesheet" type="text/css" href="data:text/css;base64,{{style}}" />
<script {{swup}} src="data:application/x-javascript;base64,{{script}}">
</script>
<script {{swup}} src="data:application/x-javascript;base64,{{init}}">
</script>
`,c=a(t)({debug:!1,silent:!1});async function u(t,i,u,d){d.item_per_page||(d.item_per_page=10),d.meta_max_line||(d.meta_max_line=4),d.customize_layout||(d.customize_layout="page"),d.swup||(d.swup=!1);let l=["do","wish","collect"],g=d[u];g.actions&&0!==g.actions.length?(g.actions=g.actions.filter(e=>l.includes(e)),0===g.actions.length&&(g.actions=l)):g.actions=l;let f=(0,e.readFileSync)((0,o.createRequire)(s).resolve("idouban/dist/index.js")),p=(0,e.readFileSync)((0,o.createRequire)(s).resolve("idouban/dist/index.css")),h=d.swup?"data-swup-reload-script":"",b={selector:"#idouban",lang:t,douban_id:d.id,type:u,quote:g.quote,page_size:d.item_per_page,max_line:d.meta_max_line};if(d.dynamic)b.actions=g.actions;else{let e=new Date().getTime(),t=await a(n).fetchData(d.id,i,u,g.actions);b.data_list=t;let o=new Date().getTime();c.info(`${t.map(e=>e.action+"("+e.items.length+")")} ${u} loaded in ${o-e} ms`)}let m=`idouban.init(${JSON.stringify(b)})`,_=r.replace(/{{style}}/g,Buffer.from(p).toString("base64")).replace(/{{script}}/g,Buffer.from(f).toString("base64")).replace(/{{init}}/g,Buffer.from(m).toString("base64")).replace(/{{swup}}/g,h);return{path:g.path,data:Object.assign({title:g.title,content:_,slug:`${u}s`},g.option),layout:[d.customize_layout,"post"]}}const d=["book","movie","game","song"],l=a(t)({debug:!1,silent:!1});d.forEach(e=>{hexo.extend.generator.register(`${e}s`,function(t){if(!this.config.douban||!this.config.douban[e]||!this.config.douban.builtin)return;let i=this.config.douban[e].path;return i?this.config.douban[e].path=i.replace(/^\//,""):this.config.douban[e].path=`${e}s/index.html`,u(this.config.lang,this.config.url,e,this.config.douban)})}),hexo.extend.console.register("douban","Generate pages from douban",{options:[{name:"-b, --books",desc:"Generate douban books only"},{name:"-m, --movies",desc:"Generate douban movies only"},{name:"-g, --games",desc:"Generate douban games only"},{name:"-s, --songs",desc:"Generate douban songs only"}]},function(t){if(!this.config.douban){l.info("No douban config specified");return}if(!this.config.douban.id){l.info("No douban id specified");return}let n=[];d.forEach(e=>{(Object.keys(t).includes(e[0])||Object.keys(t).includes(`${e}s`))&&this.config.douban[e]&&n.push(e)});let o=[];if(0!==n.length?o=n:d.forEach(e=>{this.config.douban[e]&&o.push(e)}),0===o.length){l.info("No douban type specified");return}o.forEach(e=>{let t=this.config.douban[e].path;t?this.config.douban[e].path=t.replace(/^\//,""):this.config.douban[e].path=`${e}s/index.html`,hexo.extend.generator.register(e,function(t){return u(this.config.lang,this.config.url,e,this.config.douban)})});let s=this;s.load().then(function(){o.forEach(t=>{let n=s.public_dir,o=s.config.douban[t].path;(0,e.mkdirSync)(a(i).join(n,o.replace("index.html","")),{recursive:!0}),s.route.get(o)&&(s.route.get(o).pipe((0,e.createWriteStream)(a(i).join(n,o))),l.info("Generated: %s",o))})})});